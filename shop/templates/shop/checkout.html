{% extends 'shop/basic.html' %}
{% block title%} Checkout - My Awesome Cart{% endblock %}

{% block css %}
<style>
/* Checkout Page Specific Styles */
.checkout-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4rem 0 2rem;
    position: relative;
    overflow: hidden;
}

.checkout-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="white" opacity="0.1"><polygon points="0,0 1000,0 1000,100 0,80"/></svg>');
    background-size: cover;
}

.checkout-hero-content {
    position: relative;
    z-index: 2;
}

.checkout-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.checkout-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
}

.checkout-content {
    padding: 3rem 0;
    background: #f8fafc;
}

.progress-container {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    border: 1px solid rgba(0,0,0,0.05);
}

.progress-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
}

.step-number {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #e5e7eb;
    color: #6b7280;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

.step-number.active {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
}

.step-number.completed {
    background: linear-gradient(135deg, var(--accent-color), #059669);
    color: white;
}

.step-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-align: center;
}

.step-label.active {
    color: var(--primary-color);
}

.progress-line {
    position: absolute;
    top: 25px;
    left: 0;
    right: 0;
    height: 2px;
    background: #e5e7eb;
    z-index: 1;
}

.progress-line-fill {
    height: 100%;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    width: 0%;
    transition: width 0.5s ease;
}

.cart-summary {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    border: 1px solid rgba(0,0,0,0.05);
}

.summary-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.cart-items {
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 1.5rem;
}

.cart-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 12px;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.cart-item:hover {
    background: #f1f5f9;
    transform: translateY(-2px);
}

.item-info {
    flex: 1;
}

.item-name {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.item-price {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.item-quantity-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: white;
    border-radius: 20px;
    padding: 0.25rem;
    border: 1px solid #e5e7eb;
}

.item-quantity-controls button {
    background: none;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: var(--primary-color);
    transition: all 0.2s ease;
    cursor: pointer;
}

.item-quantity-controls button:hover {
    background: var(--primary-color);
    color: white;
}

.item-quantity-controls button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.item-quantity-controls span {
    min-width: 40px;
    text-align: center;
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
}

.cart-total {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    border-radius: 15px;
    padding: 1.5rem;
    border: 1px solid rgba(14, 165, 233, 0.1);
}

.total-label {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.total-amount {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent-color);
}

.checkout-form {
    background: white;
    border-radius: 20px;
    padding: 3rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: 1px solid rgba(0,0,0,0.05);
}

.form-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-subtitle {
    color: var(--text-secondary);
    margin-bottom: 2rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    display: block;
}

.form-control {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f9fafb;
}

.form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    background: white;
    outline: none;
}

.form-control::placeholder {
    color: #9ca3af;
    transition: all 0.3s ease;
}

.form-control:focus::placeholder {
    color: transparent;
}

.form-group.focused .form-label {
    color: var(--primary-color);
    transform: translateY(-2px);
}

.form-group.focused .form-control {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    background: white;
}

.form-group {
    position: relative;
    transition: all 0.3s ease;
}

.form-label {
    transition: all 0.3s ease;
    position: relative;
}

.submit-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    border: none;
    border-radius: 15px;
    padding: 1.25rem 3rem;
    font-size: 1.2rem;
    font-weight: 600;
    color: white;
    width: 100%;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    color: white;
}

.submit-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

.submit-btn.loading {
    pointer-events: none;
}

.submit-btn.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid transparent;
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

.empty-cart {
    text-align: center;
    padding: 3rem;
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.empty-cart-icon {
    font-size: 4rem;
    color: #d1d5db;
    margin-bottom: 1rem;
}

.empty-cart-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1rem;
}

.empty-cart-text {
    color: var(--text-secondary);
    margin-bottom: 2rem;
}

.shop-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    border: none;
    border-radius: 15px;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
    color: white;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
}

.shop-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    color: white;
}

/* Responsive Design */
@media (max-width: 768px) {
    .checkout-title {
        font-size: 2rem;
    }
    
    .progress-steps {
        flex-direction: column;
        gap: 1rem;
    }
    
    .progress-line {
        display: none;
    }
    
    .checkout-form {
        padding: 2rem;
    }
    
    .cart-item {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
}

/* Dark Mode Support */
.dark-mode .checkout-content {
    background: #111827;
}

.dark-mode .progress-container,
.dark-mode .cart-summary,
.dark-mode .checkout-form,
.dark-mode .empty-cart {
    background: #1f2937;
    border-color: rgba(255, 255, 255, 0.1);
}

.dark-mode .form-control {
    background: #374151;
    border-color: #4b5563;
    color: white;
}

.dark-mode .form-control:focus {
    background: #4b5563;
    border-color: var(--primary-color);
}

.dark-mode .form-label,
.dark-mode .form-title,
.dark-mode .summary-title,
.dark-mode .empty-cart-title {
    color: white;
}

.dark-mode .form-subtitle,
.dark-mode .empty-cart-text {
    color: #d1d5db;
}

.dark-mode .cart-item {
    background: #374151;
}

.dark-mode .cart-item:hover {
    background: #4b5563;
}

.dark-mode .item-name {
    color: white;
}

.dark-mode .item-price {
    color: #d1d5db;
}

.dark-mode .cart-total {
    background: linear-gradient(135deg, #1e3a8a, #1e40af);
    border-color: rgba(59, 130, 246, 0.2);
}

.dark-mode .total-label {
    color: white;
}
</style>
{% endblock %}

{% block body %}
<!-- Checkout Hero -->
<section class="checkout-hero">
    <div class="container">
        <div class="checkout-hero-content text-center">
            <h1 class="checkout-title">
                <i class="fas fa-shopping-cart me-2"></i>Checkout
            </h1>
            <p class="checkout-subtitle">Complete your order and get your products delivered to your doorstep</p>
        </div>
    </div>
</section>

<!-- Checkout Content -->
<section class="checkout-content">
    <div class="container">
        <!-- Progress Steps -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-step">
                    <div class="step-number active">1</div>
                    <div class="step-label active">Review Cart</div>
                </div>
                <div class="progress-step">
                    <div class="step-number">2</div>
                    <div class="step-label">Shipping Details</div>
                </div>
                <div class="progress-step">
                    <div class="step-number">3</div>
                    <div class="step-label">Payment</div>
                </div>
                <div class="progress-line">
                    <div class="progress-line-fill"></div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Cart Summary -->
            <div class="col-lg-5">
                <div class="cart-summary">
                    <h3 class="summary-title">
                        <i class="fas fa-shopping-bag me-2"></i>Order Summary
                    </h3>
                    
                    <div class="cart-items" id="items">
                        <!-- Cart items will be populated here -->
                    </div>
                    
                    <div class="cart-total">
                        <div class="total-label">Total Amount</div>
                        <div class="total-amount">₹<span id="totalPrice">0</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Checkout Form -->
            <div class="col-lg-7">
                <div class="checkout-form">
                    <h3 class="form-title">
                        <i class="fas fa-shipping-fast me-2"></i>Shipping Details
                    </h3>
                    <p class="form-subtitle">Please provide your shipping information to complete your order.</p>
                    
                    <form method="post" action="/shop/pay/" id="checkoutForm" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="itemsJson" id="itemsJson">
                        <input type="hidden" name="amount" id="amount">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="name" class="form-label">
                                        <i class="fas fa-user me-1"></i>Full Name
                                    </label>
                                    <input type="text" class="form-control" id="name" name="name" 
                                           placeholder="Enter your full name" 
                                           value="{% if user.is_authenticated %}{{ user.get_full_name|default:user.username }}{% endif %}" 
                                           required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="email" class="form-label">
                                        <i class="fas fa-envelope me-1"></i>Email Address
                                    </label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           placeholder="Enter your email" 
                                           value="{% if user.is_authenticated %}{{ user.email }}{% endif %}" 
                                           required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="address1" class="form-label">
                                <i class="fas fa-map-marker-alt me-1"></i>Address Line 1
                            </label>
                            <input type="text" class="form-control" id="address1" name="address1" 
                                   placeholder="Street address, P.O. box, company name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="address2" class="form-label">
                                <i class="fas fa-building me-1"></i>Address Line 2
                            </label>
                            <input type="text" class="form-control" id="address2" name="address2" 
                                   placeholder="Apartment, suite, unit, building, floor, etc.">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="city" class="form-label">
                                        <i class="fas fa-city me-1"></i>City
                                    </label>
                                    <input type="text" class="form-control" id="city" name="city" 
                                           placeholder="Enter your city" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="state" class="form-label">
                                        <i class="fas fa-map me-1"></i>State
                                    </label>
                                    <input type="text" class="form-control" id="state" name="state" 
                                           placeholder="State" required>
                                </div>
                            </div>
                            <div class="col-md-3">
            <div class="form-group">
                                    <label for="zip_code" class="form-label">
                                        <i class="fas fa-mail-bulk me-1"></i>ZIP Code
                                    </label>
                                    <input type="text" class="form-control" id="zip_code" name="zip_code" 
                                           placeholder="ZIP" required>
                                </div>
            </div>
                </div>
                        
                        <div class="form-group">
                            <label for="phone" class="form-label">
                                <i class="fas fa-phone me-1"></i>Phone Number
                            </label>
                            <input type="tel" class="form-control" id="phone" name="phone" 
                                   placeholder="Enter your phone number" required>
                </div>
                        
                        <button type="submit" class="submit-btn" id="submitBtn">
                            <i class="fas fa-credit-card me-2"></i>Proceed to Payment
                        </button>

                        <button type="button" class="btn btn-outline-secondary btn-sm w-100 mt-3" onclick="window.location.href='/shop'">
                            <i class="fas fa-arrow-left me-1"></i>Back to Shop
                        </button>
                    </form>
                </div>
            </div>
            </div>
    </div>
</section>
{% endblock %}
{% block js %}
<script>
// Function to update quantity in checkout
window.updateCheckoutQuantity = function(productId, newQty) {
    let cart = localStorage.getItem('cart') ? JSON.parse(localStorage.getItem('cart')) : {};
    const itemKey = 'pr' + productId;

    if (cart[itemKey] && newQty > 0) {
        cart[itemKey][0] = newQty;
        localStorage.setItem('cart', JSON.stringify(cart));
        // Update cart component if it exists
        if (typeof window.newCartComponent !== 'undefined' && typeof window.newCartComponent.updateQuantity === 'function') {
            window.newCartComponent.updateQuantity(productId, newQty);
        }
        updateCheckoutDisplay();
    } else if (cart[itemKey] && newQty <= 0) {
        delete cart[itemKey];
        localStorage.setItem('cart', JSON.stringify(cart));
        if (typeof window.newCartComponent !== 'undefined' && typeof window.newCartComponent.removeItem === 'function') {
            window.newCartComponent.removeItem(productId);
        }
        updateCheckoutDisplay();
    }
};

// Function to update the checkout display dynamically without reload
function updateCheckoutDisplay() {
    let cart = localStorage.getItem('cart') ? JSON.parse(localStorage.getItem('cart')) : {};
    let sum = 0;
    let totalPrice = 0;
    const itemsContainer = document.getElementById('items');
    const totalPriceElement = document.getElementById('totalPrice');
    const cartCountElement = document.getElementById('cart');

    itemsContainer.innerHTML = '';

    if (Object.keys(cart).length === 0) {
        itemsContainer.innerHTML = `
            <div class="empty-cart">
                <div class="empty-cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h4 class="empty-cart-title">Your cart is empty</h4>
                <p class="empty-cart-text">Please add some items to your cart before checking out.</p>
                <a href="/shop" class="shop-btn">
                    <i class="fas fa-shopping-bag me-2"></i>Shop Now
                </a>
            </div>
        `;
    } else {
        for (let item in cart) {
            let name = cart[item][1];
            let qty = cart[item][0];
            let itemPrice = parseFloat(cart[item][2]);
            let itemTotal = qty * itemPrice;

            sum += qty;
            totalPrice += itemTotal;

            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.setAttribute('data-product-id', item.replace('pr', ''));
            cartItem.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${name}</div>
                    <div class="item-price">₹${itemPrice.toLocaleString()} each</div>
                </div>
                <div class="item-quantity-controls">
                    <button class="decrease-qty" ${qty <= 1 ? 'disabled' : ''}>
                        <i class="fas fa-minus"></i>
                    </button>
                    <span>${qty}</span>
                    <button class="increase-qty">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            `;
            itemsContainer.appendChild(cartItem);
        }
    }

    if (cartCountElement) cartCountElement.textContent = sum;
    totalPriceElement.textContent = totalPrice.toLocaleString();

    // Update hidden inputs for form submission
    const itemsJsonInput = document.getElementById('itemsJson');
    const amountInput = document.getElementById('amount');
    itemsJsonInput.value = JSON.stringify(cart);
    amountInput.value = totalPrice;
}

document.addEventListener('DOMContentLoaded', function() {
    // Load cart from localStorage
    let cart = localStorage.getItem('cart') ? JSON.parse(localStorage.getItem('cart')) : {};
    let sum = 0;
    let totalPrice = 0;

    const itemsContainer = document.getElementById('items');
    const totalPriceElement = document.getElementById('totalPrice');
    const cartCountElement = document.getElementById('cart');
    const itemsJsonInput = document.getElementById('itemsJson');
    const amountInput = document.getElementById('amount');

    // Attach event listeners for quantity buttons using delegation
    itemsContainer.addEventListener('click', function(e) {
        const button = e.target.closest('.decrease-qty') || e.target.closest('.increase-qty');
        if (button) {
            const cartItem = e.target.closest('.cart-item');
            const productId = cartItem.getAttribute('data-product-id');
            const qtySpan = cartItem.querySelector('span');
            const decreaseBtn = cartItem.querySelector('.decrease-qty');
            let qty = parseInt(qtySpan.textContent);

            if (button.classList.contains('decrease-qty')) {
                if (qty > 1) {
                    qty--;
                }
            } else {
                qty++;
            }

            qtySpan.textContent = qty;
            decreaseBtn.disabled = qty <= 1;
            updateCheckoutQuantity(productId, qty);
        }
    });

    // Variables from Django context
    var is_authenticated = {{ user.is_authenticated|yesno:"true,false" }};
    var thank = {{ thank|default:"False"|yesno:"true,false" }};
    var user_full_name = "{{ user.get_full_name|default:user.username|escapejs }}";
    var user_email = "{{ user.email|escapejs }}";
    var order_id = "{{ id|default:''|escapejs }}";

    // Auto-populate form fields if user is authenticated
    const nameField = document.getElementById('name');
    const emailField = document.getElementById('email');

    // Check if fields are empty and user is authenticated
    if (is_authenticated) {
        if (nameField && !nameField.value.trim()) {
            nameField.value = user_full_name;
        }
        if (emailField && !emailField.value.trim()) {
            emailField.value = user_email;
        }
    }


    


    // Check if cart is empty
    if (Object.keys(cart).length === 0) {
        itemsContainer.innerHTML = `
            <div class="empty-cart">
                <div class="empty-cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h4 class="empty-cart-title">Your cart is empty</h4>
                <p class="empty-cart-text">Please add some items to your cart before checking out.</p>
                <a href="/shop" class="shop-btn">
                    <i class="fas fa-shopping-bag me-2"></i>Shop Now
                </a>
            </div>
        `;
} else {
        console.log("Cart data:", cart);
        // Display cart items
        for (let item in cart) {
        let name = cart[item][1];
        let qty = cart[item][0];
        let itemPrice = parseFloat(cart[item][2]);
            let itemTotal = qty * itemPrice;
            console.log(`Item: ${name}, Qty: ${qty}, Price: ${itemPrice}, Total: ${itemTotal}`);
            sum += qty;
            totalPrice += itemTotal;
            
            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.setAttribute('data-product-id', item.replace('pr', ''));
            cartItem.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${name}</div>
                    <div class="item-price">₹${itemPrice.toLocaleString()} each</div>
                </div>
                    <div class="item-quantity-controls">
                        <button class="decrease-qty" ${qty <= 1 ? 'disabled' : ''}>
                            <i class="fas fa-minus"></i>
                        </button>
                        <span>${qty}</span>
                        <button class="increase-qty">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
            `;
            itemsContainer.appendChild(cartItem);
        }
    }
    
    // Update totals
    if (cartCountElement) cartCountElement.textContent = sum;
    totalPriceElement.textContent = totalPrice.toLocaleString();
    itemsJsonInput.value = JSON.stringify(cart);
    amountInput.value = totalPrice;
    
    // Form validation and submission
    const form = document.getElementById('checkoutForm');
    const submitBtn = document.getElementById('submitBtn');
    
    // Form validation
    function validateField(field) {
        const value = field.value.trim();
        const fieldName = field.name;
        let isValid = true;
        let message = '';
        
        // Remove existing validation classes
        field.classList.remove('is-valid', 'is-invalid');
        
        // Validation rules
        switch(fieldName) {
            case 'name':
                if (value.length < 2) {
                    isValid = false;
                    message = 'Name must be at least 2 characters long.';
                }
                break;
            case 'email':
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(value)) {
                    isValid = false;
                    message = 'Please enter a valid email address.';
                }
                break;
            case 'phone':
                const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
                if (!phoneRegex.test(value.replace(/[\s\-\(\)]/g, ''))) {
                    isValid = false;
                    message = 'Please enter a valid phone number.';
                }
                break;
            case 'address1':
                if (value.length < 5) {
                    isValid = false;
                    message = 'Please enter a complete address.';
                }
                break;
            case 'city':
                if (value.length < 2) {
                    isValid = false;
                    message = 'Please enter a valid city name.';
                }
                break;
            case 'state':
                if (value.length < 2) {
                    isValid = false;
                    message = 'Please enter a valid state name.';
                }
                break;
            case 'zip_code':
                if (value.length < 3) {
                    isValid = false;
                    message = 'Please enter a valid ZIP code.';
                }
                break;
        }
        
        // Apply validation styling
        if (isValid) {
            field.classList.add('is-valid');
        } else {
            field.classList.add('is-invalid');
        }
        
        return isValid;
    }
    
    // Real-time validation
    form.querySelectorAll('input[required]').forEach(field => {
        field.addEventListener('blur', () => validateField(field));
        field.addEventListener('input', () => {
            if (field.classList.contains('is-invalid')) {
                validateField(field);
            }
        });
    });
    
    // Add focus effects to form fields
    form.querySelectorAll('.form-control').forEach(field => {
        field.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });
        
        field.addEventListener('blur', function() {
            if (!this.value.trim()) {
                this.parentElement.classList.remove('focused');
            }
        });
        
        // Check if field has value on load
        if (field.value.trim()) {
            field.parentElement.classList.add('focused');
        }
        
        // Save form data to localStorage
        field.addEventListener('input', function() {
            const formData = {};
            form.querySelectorAll('.form-control').forEach(f => {
                if (f.value.trim()) {
                    formData[f.name] = f.value;
                }
            });
            localStorage.setItem('checkoutFormData', JSON.stringify(formData));
        });
    });
    
    // Load saved form data
    const savedFormData = localStorage.getItem('checkoutFormData');
    if (savedFormData) {
        const formData = JSON.parse(savedFormData);
        Object.keys(formData).forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (field && !field.value.trim()) {
                field.value = formData[fieldName];
                field.parentElement.classList.add('focused');
            }
        });
    }
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Check if cart is empty
        let cart = localStorage.getItem('cart') ? JSON.parse(localStorage.getItem('cart')) : {};
        if (Object.keys(cart).length === 0) {
            showNotification('Your cart is empty. Please add items to your cart before proceeding.', 'warning');
            return;
        }

        // Check if total amount is valid
        const totalPrice = parseFloat(document.getElementById('totalPrice').textContent.replace(/,/g, ''));
        if (totalPrice <= 0) {
            showNotification('Invalid order amount. Please check your cart.', 'danger');
            return;
        }

        // Validate all fields
        const fields = form.querySelectorAll('input[required]');
        let isFormValid = true;

        fields.forEach(field => {
            if (!validateField(field)) {
                isFormValid = false;
            }
        });

        if (isFormValid) {
            // Show loading state
            submitBtn.classList.add('loading');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

            // Update progress
            updateProgress(2);

            // Clear saved form data
            localStorage.removeItem('checkoutFormData');

            // Submit form to payment page
            setTimeout(() => {
                // Submit the form to the payment page
                form.submit();
            }, 1500);
        } else {
            showNotification('Please fill in all required fields correctly.', 'danger');
        }
    });
    
    // Update progress indicator
    function updateProgress(step) {
        const progressLine = document.querySelector('.progress-line-fill');
        const stepNumbers = document.querySelectorAll('.step-number');
        const stepLabels = document.querySelectorAll('.step-label');
        
        // Update progress line
        progressLine.style.width = `${(step - 1) * 50}%`;
        
        // Update step indicators
        stepNumbers.forEach((stepNum, index) => {
            if (index < step) {
                stepNum.classList.add('completed');
                stepNum.classList.remove('active');
            } else if (index === step) {
                stepNum.classList.add('active');
                stepNum.classList.remove('completed');
            } else {
                stepNum.classList.remove('active', 'completed');
            }
        });
        
        stepLabels.forEach((label, index) => {
            if (index < step) {
                label.classList.add('active');
            } else {
                label.classList.remove('active');
            }
        });
    }
    
    // Notification function
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 120px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    // Add loading animation to cart items
    const cartItems = document.querySelectorAll('.cart-item');
    cartItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            item.style.transition = 'all 0.6s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
        }, index * 100);
    });

// Handle thank you message
{% if thank %}
    showNotification('Thanks for ordering with us! Your order ID is {{id}}. Use it to track your order.', 'success');
    localStorage.removeItem('cart');
    setTimeout(() => {
        window.location.href = "/shop";
    }, 3000);
{% endif %}
});
</script>
{% endblock %}
