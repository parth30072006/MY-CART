<!-- Fully Working Modern Cart Component with Bootstrap 5 -->

<div class="cart-component">
    <button class="btn btn-primary position-relative d-flex align-items-center" id="cart-button" aria-label="Open shopping cart" style="gap: 0.25rem;">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-count-badge" class="badge bg-danger rounded-pill" style="display:none; font-size: 0.75rem; min-width: 18px; height: 18px; line-height: 18px; padding: 0;">0</span>
    </button>
</div>

<!-- Cart Modal -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cartModalLabel"><i class="fas fa-shopping-cart me-2"></i>My Cart (<span id="cart-total-items">0</span>)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="cart-items-container" style="padding: 1rem;">
        <!-- Cart items will be dynamically inserted here -->
      </div>
      <div class="modal-footer d-flex flex-column align-items-stretch">

        

        <div class="d-flex justify-content-between mb-3 border-top pt-2">
          <div><strong>Total:</strong></div>
          <div>₹<span id="cart-total">0</span></div>
        </div>
        <button type="button" class="btn btn-danger mb-2" id="clear-cart-btn" aria-label="Clear cart">Clear Cart</button>
        <a href="/shop/checkout/" class="btn btn-success" id="checkout-btn" aria-label="Proceed to checkout">Proceed to Checkout</a>
      </div>
    </div>
  </div>
</div>

<style>
/* Fix modal backdrop and pointer events issues */
/* .modal-backdrop {
    z-index: 1040 !important;
} */

/* .modal {
    z-index: 1050 !important;
    pointer-events: auto !important;
} */

.cart-component #cart-button {
    border-radius: 30px;
    padding: 0.75rem 1.25rem;
    font-weight: 700;
    font-size: 1rem;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border: none;
    color: white;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.cart-component #cart-button:hover {
    background: linear-gradient(135deg, #1d4ed8, #1e40af);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}

#cart-items-container {
    max-height: 400px;
    overflow-y: auto;
}

.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e5e7eb;
}

.cart-item:last-child {
    border-bottom: none;
}

.cart-item-info {
    flex: 1;
}

.cart-item-name {
    font-weight: 600;
    font-size: 1rem;
    color: #1f2937;
}

.cart-item-price {
    font-size: 0.9rem;
    color: #6b7280;
}

.cart-item-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.cart-item-controls button {
    background: none;
    border: none;
    font-size: 1.2rem;
    color: #3b82f6;
    cursor: pointer;
    transition: color 0.2s ease;
}

.cart-item-controls button:hover {
    color: #1d4ed8;
}

.cart-empty {
    text-align: center;
    padding: 2rem 1rem;
    color: #6b7280;
    font-size: 1.1rem;
}
</style>

<script>
class NewCartComponent {
    constructor() {
        this.cart = this.loadCart();
        this.init();
    }

    loadCart() {
        try {
            return localStorage.getItem('cart') ? JSON.parse(localStorage.getItem('cart')) : {};
        } catch {
            return {};
        }
    }

    saveCart() {
        localStorage.setItem('cart', JSON.stringify(this.cart));
    }

    init() {
        this.cartButton = document.getElementById('cart-button');
        this.cartCountBadge = document.getElementById('cart-count-badge');
        this.cartItemsContainer = document.getElementById('cart-items-container');
        this.cartTotalItems = document.getElementById('cart-total-items');

        this.cartTotal = document.getElementById('cart-total');
        this.clearCartBtn = document.getElementById('clear-cart-btn');
        this.checkoutBtn = document.getElementById('checkout-btn');

        // Create modal instance once
        this.modal = new bootstrap.Modal(document.getElementById('cartModal'), {
            backdrop: false  // Disable automatic backdrop insertion
        });

        this.cartButton.addEventListener('click', () => {
            this.renderCart();
            this.modal.toggle();
        });

        this.clearCartBtn.addEventListener('click', () => {
            this.clearCart();
        });

        this.cartItemsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const item = button.closest('.cart-item');
            if (!item) return;
            const productId = item.dataset.productId;
            if (button.classList.contains('increase-qty')) {
                const qtySpan = item.querySelector('.cart-item-controls span');
                const currentQty = parseInt(qtySpan.textContent);
                this.updateQuantity(productId, currentQty + 1);
            } else if (button.classList.contains('decrease-qty')) {
                const qtySpan = item.querySelector('.cart-item-controls span');
                const currentQty = parseInt(qtySpan.textContent);
                this.updateQuantity(productId, currentQty - 1);
            } else if (button.classList.contains('remove-item')) {
                this.removeItem(productId);
            }
        });

        this.renderCart();
    }

    renderCart() {
        const items = Object.entries(this.cart);
        if (items.length === 0) {
            this.cartItemsContainer.innerHTML = `<div class="cart-empty"><i class="fas fa-shopping-cart"></i> Your cart is empty.</div>`;
            this.cartTotalItems.textContent = '0';
            this.cartCountBadge.style.display = 'none';

            this.cartTotal.textContent = '0';
            this.checkoutBtn.classList.add('disabled');
            this.clearCartBtn.disabled = true;
            return;
        }

        let subtotal = 0;
        let html = '';
        for (const [key, [qty, name, price]] of items) {
            const productId = key.replace('pr', '');
            subtotal += qty * price;
            html += `
                <div class="cart-item" data-product-id="${productId}">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${name}</div>
                        <div class="cart-item-price">₹${price.toLocaleString()} each</div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="decrease-qty" aria-label="Decrease quantity" ${qty <= 1 ? 'disabled' : ''}><i class="fas fa-minus"></i></button>
                        <span>${qty}</span>
                        <button class="increase-qty" aria-label="Increase quantity"><i class="fas fa-plus"></i></button>
                        <button class="remove-item" aria-label="Remove item" style="color:#dc2626;"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }

        this.cartItemsContainer.innerHTML = html;
        this.cartTotalItems.textContent = items.reduce((acc, [_, [qty]]) => acc + qty, 0);
        this.cartCountBadge.textContent = this.cartTotalItems.textContent;
        this.cartCountBadge.style.display = 'inline-block';


        this.cartTotal.textContent = subtotal.toLocaleString();

        this.checkoutBtn.classList.remove('disabled');
        this.clearCartBtn.disabled = false;
    }

    addItem(productId, productName, price, quantity = 1) {
        const key = 'pr' + productId;
        if (this.cart[key]) {
            this.cart[key][0] += quantity;
        } else {
            this.cart[key] = [quantity, productName, price];
        }
        this.saveCart();
        this.renderCart();
    }

    removeItem(productId) {
        const key = 'pr' + productId;
        if (this.cart[key]) {
            delete this.cart[key];
            this.saveCart();
            this.renderCart();
        }
    }

    updateQuantity(productId, quantity) {
        const key = 'pr' + productId;
        if (this.cart[key]) {
            if (quantity <= 0) {
                this.removeItem(productId);
            } else {
                this.cart[key][0] = quantity;
                this.saveCart();
                this.renderCart();
            }
        }
    }

    clearCart() {
        this.cart = {};
        this.saveCart();
        this.renderCart();
    }
}

// Initialize global instance
let newCartComponent = null;
document.addEventListener('DOMContentLoaded', () => {
    if (!window.newCartComponent) {
        window.newCartComponent = new NewCartComponent();
    }
});

// Expose global functions for backward compatibility
window.addToGlobalCart = function(productId, productName, price, quantity = 1) {
    return window.newCartComponent.addItem(productId, productName, price, quantity);
};
window.removeFromGlobalCart = function(productId) {
    return window.newCartComponent.removeItem(productId);
};
window.updateGlobalCartItem = function(productId, quantity) {
    return window.newCartComponent.updateQuantity(productId, quantity);
};
window.clearGlobalCart = function() {
    return window.newCartComponent.clearCart();
};
window.updateGlobalCart = function() {
    return window.newCartComponent.renderCart();
};
window.refreshGlobalCart = function() {
    return window.newCartComponent.renderCart();
};
window.getGlobalCart = function() {
    return window.newCartComponent.cart;
};
</script>
